# 类别数不匹配问题解决方案

## 问题描述

训练时出现错误:
```
Assertion `t >= 0 && t < n_classes` failed
```

**原因**: 数据集的标签值超出了模型支持的类别范围。

---

## 快速诊断

### 步骤1: 运行诊断工具

```bash
cd TET_improve/temporal_efficient_training

# 诊断CIFAR-100数据集
python diagnose_class_mismatch.py /path/to/cifar100 --model VGGSNN

# 诊断CIFAR-10数据集
python diagnose_class_mismatch.py /path/to/cifar10 --model VGGSNN --cifar10
```

**示例输出:**
```
================================================================================
诊断结果:
================================================================================
❌ 类别数不匹配!
   数据集实际类别: 100
   数据集标签范围: [0, 99]
   模型类别数: 10
   模型接受范围: [0, 9]

问题分析:
   ⚠️  标签最大值 99 超出模型范围 [0, 9]
   ⚠️  数据集有 100 个类别,但模型只支持 10 类
```

---

## 解决方案

### 方案1: 使用命令行参数指定类别数(推荐)

训练脚本现已支持 `--num-classes` 和 `--dataset` 参数:

```bash
# CIFAR-100训练
python main_training_distribute_improved.py \
    --dataset cifar100 \
    --num-classes 100 \
    --data-path /path/to/cifar100 \
    --model VGGSNN \
    --epochs 320 \
    --nprocs 4

# CIFAR-10训练
python main_training_distribute_improved.py \
    --dataset cifar10 \
    --num-classes 10 \
    --data-path /path/to/cifar10 \
    --model VGGSNN \
    --nprocs 4

# DVS-CIFAR10训练
python main_training_distribute_improved.py \
    --dataset dvscifar10 \
    --num-classes 10 \
    --data-path /path/to/dvs-cifar10 \
    --model VGGSNN \
    --nprocs 4
```

---

### 方案2: 使用训练脚本

修改 `train.sh` 中的参数:

```bash
# ===================== 配置参数 =====================
# 数据集配置
DATASET="cifar100"       # 数据集类型: dvscifar10 / cifar10 / cifar100
DATA_PATH="/path/to/your/cifar100"
NUM_CLASSES=100          # 类别数: 根据数据集设置

# 模型参数
MODEL="VGGSNN"           # 模型: VGGSNN / resnet19
T=4
LAMBDA=1e-4

# 训练参数
EPOCHS=320
BATCH_SIZE=16
LR=0.1
WORKERS=4
NPROCS=4
```

然后运行:
```bash
bash train.sh
```

---

## 支持的数据集配置

### DVS-CIFAR10
```bash
--dataset dvscifar10
--num-classes 10
--data-path /path/to/dvs-cifar10
```

### CIFAR-10
```bash
--dataset cifar10
--num-classes 10
--data-path /path/to/cifar10
```

### CIFAR-100
```bash
--dataset cifar100
--num-classes 100
--data-path /path/to/cifar100
```

---

## 完整训练示例

### 示例1: 训练CIFAR-100

```bash
# 1. 先诊断数据集
python diagnose_class_mismatch.py /data/cifar100

# 输出显示: 实际类别数 100

# 2. 运行训练(使用正确的类别数)
python main_training_distribute_improved.py \
    --dataset cifar100 \
    --num-classes 100 \
    --data-path /data/cifar100 \
    --model VGGSNN \
    --T 4 \
    --lamb 1e-4 \
    --epochs 320 \
    --batch-size 16 \
    --lr 0.1 \
    --nprocs 4 \
    --output-dir ./runs
```

### 示例2: 训练CIFAR-10

```bash
python main_training_distribute_improved.py \
    --dataset cifar10 \
    --num-classes 10 \
    --data-path /data/cifar10 \
    --model VGGSNN \
    --T 4 \
    --epochs 320 \
    --nprocs 4
```

---

## 代码修改说明

### 1. 模型支持自定义类别数

**VGG模型** (`models/VGG_models.py`):
```python
class VGGSNN(nn.Module):
    def __init__(self, num_classes=10):  # 添加num_classes参数
        super(VGGSNN, self).__init__()
        # ...
        self.classifier = SeqToANNContainer(
            nn.Linear(512*W*W, num_classes)  # 使用num_classes
        )
```

**ResNet模型** (已支持):
```python
model = resnet19(num_classes=100)
```

### 2. 训练脚本支持数据集类型

新增参数:
- `--dataset`: 数据集类型 (dvscifar10 / cifar10 / cifar100)
- `--num-classes`: 类别数

### 3. 自动加载对应数据集

```python
if args.dataset == 'dvscifar10':
    train_dataset, val_dataset = data_loaders.build_dvscifar(args.data_path)
elif args.dataset == 'cifar10':
    train_dataset, val_dataset = data_loaders.auto_build_cifar(
        data_path=args.data_path, use_cifar10=True
    )
elif args.dataset == 'cifar100':
    train_dataset, val_dataset = data_loaders.auto_build_cifar(
        data_path=args.data_path, use_cifar10=False
    )
```

---

## 常见问题

### Q1: 如何确定我的数据集有多少类?

**运行诊断工具:**
```bash
python diagnose_class_mismatch.py /path/to/your/data
```

或

**运行测试脚本:**
```bash
python test_dataloader.py /path/to/your/data
```

### Q2: 我的数据集不是标准的CIFAR格式怎么办?

**使用图片文件夹格式:**
1. 确保数据组织为类别文件夹结构
2. 运行格式检测: `python check_data_format.py /path/to/data`
3. 代码会自动检测并加载

### Q3: 训练脚本如何自动适配类别数?

**当前版本需要手动指定:**
```bash
--num-classes 100  # 手动指定
```

**未来版本可以添加自动检测:**
```python
# 在训练开始前自动检测
sample_data, sample_label = train_dataset[0]
# 统计所有标签...
args.num_classes = detected_classes
```

---

## 验证修复

### 1. 诊断测试
```bash
python diagnose_class_mismatch.py /path/to/data --model VGGSNN
```

### 2. 数据加载测试
```bash
python test_dataloader.py /path/to/data
```

### 3. 运行训练(短时测试)
```bash
python main_training_distribute_improved.py \
    --dataset cifar100 \
    --num-classes 100 \
    --data-path /path/to/cifar100 \
    --epochs 2 \
    --nprocs 2
```

如果能正常训练几个batch而不报错,说明修复成功!

---

## 总结

**关键修改:**
1. ✅ VGG模型支持自定义类别数
2. ✅ 训练脚本支持 `--dataset` 和 `--num-classes` 参数
3. ✅ 自动加载对应数据集格式
4. ✅ 添加诊断工具快速定位问题

**使用方法:**
```bash
# 诊断
python diagnose_class_mismatch.py /path/to/data

# 训练(指定正确的类别数)
python main_training_distribute_improved.py \
    --dataset cifar100 \
    --num-classes 100 \
    --data-path /path/to/data \
    ...
```
